name: Sync Feature Matrix

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Download and parse sheet
        env:
          SHEET_ID: ${{ secrets.FEATURE_MATRIX_SHEET_ID }}
        run: curl -s https://docs.google.com/spreadsheets/d/$SHEET_ID/gviz/tq?tqx=out:html | pandoc --from html --to markdown_strict+pipe_tables -o doc/src/feature-matrix.md
      - name: Clean up the document
        run: |
          # add title
          sed -i "1i# Feature Matrix\nComparison of implemented features across Revolt's clients.\n" doc/src/feature-matrix.md

          # replace the indicators
          sed -i 's/| O /| ‚úÖ /g' doc/src/feature-matrix.md
          sed -i 's/| X /| ‚ùå /g' doc/src/feature-matrix.md
          sed -i 's/| Partly /| üöß /g' doc/src/feature-matrix.md
          sed -i 's/| NoPlan /| ‚õî /g' doc/src/feature-matrix.md

          # remove extra rows
          sed -i '4d' doc/src/feature-matrix.md
          sed -i '4d' doc/src/feature-matrix.md
          sed -i '4d' doc/src/feature-matrix.md

          # set column properties again (while adding header line)
          sed -i '5i |---|---|---|---|:-:|:-:|:-:|:-:|:-:|' doc/src/feature-matrix.md
      - name: Commit changes
        run: |
          git config --global user.name 'Revolt CI'
          git config --global user.email 'revolt-ci@users.noreply.github.com'
          git commit -am "chore(docs): update feature matrix"
          git push
